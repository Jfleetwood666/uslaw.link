<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>uslaw.link</title>

        <meta name="description" content="Create permalinks to the law by pasting a citation.">

        <meta name="twitter:creator" content="@JoshData" />

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha256-MfvZlkHCEqatNoGiOXveE8FIwMzZg4W85qfrfIFBfYc=" crossorigin="anonymous">
        <style>
            @import url(https://fonts.googleapis.com/css?family=Roboto+Slab:300,700);

            body {
                overflow-y: scroll;
                padding-top: 50px;
                padding-bottom: 20px;
            }

            a {
                color: #13F;
            }

            .cite-font {
                font-family: 'Roboto Slab', serif;
            }

            #jumbotron {
                background-color: #EEE;
                padding: 1.5em 0;
                margin-bottom: 32px;
            }
                #jumbotron input {
                    font-weight: bold;
                    font-size: 26px;
                    height: 42px;
                    padding: 6px 12px;
                    line-height: 1.4;
                    color: #111;
                }

            #examples {
            }
            #examples h4, #examples h5 {
                font-weight: bold;
            }
            #examples p {
                font-size: 14px;
                margin-bottom: .5em;
            }

            .citation {
                margin-bottom: 1em;
            }
                .citation.not-first {
                    border-top: 1px solid #ddd;
                    padding-top: 1em;
                }
                .citation .subhead {
                    font-size: 90%;
                    font-style: italic;
                }
                .citation a {
                    text-decoration: underline;
                }
                .citation .link a {
                    text-decoration: none;
                }

            h2 {
                margin: 0;
                font-size: 32px;
                font-weight: bold;
            }

            h3 {
                margin: 0;
                font-size: 16px;
                font-weight: bold;
            }

            .citation img {
                margin-bottom: 1em;
            }
            .citation img.empty {
                   width: 100%;
                   height: 3em;
                   border: 1px solid #DDD;
                }

            .cite-authority {
                margin-top: 2px;
                font-family: 'Roboto Slab', serif;
                font-weight: 300;
                font-size: 24px;
                margin-bottom: .75em;
                color: black;
            }
                .parallel-cites .cite-authority {
                    font-size: 14px;
                    margin-bottom: .5em;
                }

            .permalinks > .row {
                margin-bottom: 1em;
            }

            .link {
                margin-bottom: .25em;
            }
            .link a {
                font-size: 115%;
                font-weight: bold;
            }

            .other a {
                margin-left: 1em;
            }

            p.note {
                font-style: italic;
            }

            .parallel-cites {
                margin-top: 1.75em;
            }

            footer {
                margin-top: 32px;
                background-color: #EEE;
                padding: 1.5em 0;
                font-size: 90%;
            }
                footer p:last-child {
                    margin: 0;
                }

        </style>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css" integrity="sha256-bHQiqcFbnJb1Qhh61RY9cMh6kR0gTuQY6iFOBj1yj00=" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" integrity="sha256-VBrFgheoreGl4pKmWgZh3J23pJrhNlSUOBek+8Z2Gv0=" crossorigin="anonymous">

        <!--[if lt IE 9]>
            <script src="static/js/html5-3.6-respond-1.1.0.min.js"></script>
        <![endif]-->
    </head>
    <body>

    <!--[if lt IE 8]><p>Internet Explorer version 8 or any modern web browser is required to use this website, sorry.<![endif]-->
    <!--[if gt IE 7]><!-->

    <a href="https://github.com/unitedstates/uslaw.link"><img style="position: absolute; top: 0; right: 0; border: 0; z-index: 1031; max-height: 90px;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>

    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="/">uslaw.link</a>
        </div>
      </div><!-- /.container-fluid -->
    </nav>

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div id="jumbotron">
      <div class="container">
        <form onsubmit="return run_from_form()">
            <input id="citation" type="text" class="form-control cite-font" placeholder="enter a citation" title="Enter a citation." style="margin: .5em 0 1em 0;">
        </form>
        <p style="margin-bottom: 1em">
            <a class="btn btn-primary" role="button" onclick="run_from_form()">Get a Link &raquo;</a>
            <a id="examples-toggle" class="btn btn-default" role="button" onclick="$('#examples-toggle').toggleClass('active', !$('#examples').is(':visible')); $('#examples').slideToggle();">Help</a>
        </p>

        <div id="examples" style="display: none">
            <div>Enter a citation in any of the following formats:</div>
            <div class="row">
                <div class="col-xs-4">
                    <h5>Federal Statutory Law</h5>
                    <p title="United States Code">40 U.S.C. ยง 11101(1)</p>
                    <p title="United States Statutes at Large">118 Stat 3910</p>
                    <p title="Public/Private Law Number / Slip Law">PubL 110-84</p>
                </div>

                <div class="col-xs-4">
                    <h5>Federal Administrative Law</h5>
                    <p title="Code of Federal Regulations">5 CFR ยง531.610(f)</p>
                    <p title="Federal Register">75 Fed. Reg. 28404</p>
                </div>

                <div class="col-xs-4">
                    <h5>Federal Case Law/Other</h5>
                    <p title="U.S. Reporter">410 U.S. 113</p>
                    <p title="Federal Reporter">214 F.3d 416</p>
                    <p title="U.S. Constitution">U.S. CONST., art. VI, cl. 2</p>
                </div>

                <div class="clearfix"> </div>

                <div class="col-xs-4">
                    <h5>Municipal Laws</h5>
                    <p title="DC Code">DC Official Code 2-592</p>
                    <p title="VA Code">VA Code ยง 30-178</p>
                </div>
            </div>
        </div>

        <hr style="margin: 2em 0 1em 0; border-color: #CCC;">

        <div style="font-size: 13px;">
            <p><img src="ddg.png" width="24" height="24" style="margin-right: .33em"/> Use <a href="https://duckduckgo.com/">duckduckgo</a>? The <a href="https://duckduckgo.com/bang?q=uslaw">!uslaw</a> bang takes you here.</p>

            <p><b>uslaw.link</b> is based on <a href="https://github.com/unitedstates/citation">unitedstates/citation</a>. For live linking of citations, try <a href="https://github.com/18F/linkify-citations">18F/linkify-citations</a>.</p>
        </div>
      </div>
    </div>

    <div class="container">
        <div id="results-container">
            <div id="results">
            </div>
        </div>
    </div> <!-- /container -->

    <footer>
        <div class="container">
           <p>Source code is at <a href="https://github.com/unitedstates/uslaw.link">https://github.com/unitedstates/uslaw.link</a>.</p>
           <p>Contact <a href="https://razor.occams.info">Joshua Tauberer</a> at <a href="mailto:hello@uslaw.link">hello@uslaw.link</a> with any questions.</p>
        </div>
    </footer>

        <div id="ajax_loading_indicator" style="display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; z-index: 100000; text-align: center; background-color: rgba(255,255,255,.75)">
          <div style="margin: 20% auto">
            <div><span class="fa fa-spinner fa-pulse"></span></div>
            <div>Loading...</div>
          </div>
        </div>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js" integrity="sha256-rsPUGdUPBXgalvIj4YKJrrUlmLXbOb6Cp7cdxn1qeUc=" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" integrity="sha256-Sk3nkD6mLTMOF0EOpNtsIry+s1CsaqQC1rVLTAy+0yc=" crossorigin="anonymous"></script>

        <script>
        function parse_qs(qs) {
          // Parse something that looks like a query string. Based on
          // http://stackoverflow.com/a/2880929/125992.
          var match,
            pl     = /\+/g,  // Regex for replacing addition symbol with a space
            search = /([^&=]+)=?([^&]*)/g,
            decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
            ret = {};
          while (match = search.exec(qs))
            ret[decode(match[1])] = decode(match[2]);
          return ret;
        }

        $(function() {
          // Make examples links - transform each example to a link that shows it.
          $('#examples p').each(function() {
            var ex = $(this).text();
            $(this).text('');
            $(this).append($('<a/>').text(ex).attr('href', '#').click(function() { run_from_text(ex); return false }));
          })

          // Run citator when the page hash changes, and immediately if
          // the location fragment already has a citation.
          $(window).on('hashchange', citator);
          citator();
          $('#citation').focus();
        });

        function run_from_form() {
            run_from_text($('#citation').val())
            return false; // cancel form submit
        }

        function run_from_text(text) {
            // Make this page a permalink. Put the citation into the URL
            // fragment using query string-style encoding.
            if (/^\s*$/.exec(text)) return; // can't run an empty string
            window.location.hash = "#" + $.param({ q: text });
            // window hashchange event will fire, triggering the citator
        }

        function citator() {
            var state = parse_qs(window.location.hash.substring(1));
            if (!state.q) return;

            $('#citation').val(state.q);

            $('#examples-toggle').toggleClass('active', false); 
            $('#examples').slideUp();

            ajax_with_indicator({
                url: '/citation/find',
                data: {
                    text: state.q
                },
                success: function(citations) {
                    if (citations.length == 0) {
                        alert("The citation was not understood.");
                        return;
                    }

                    // display results

                    // pin height of wrapper container
                    $('#results-container').height($('#results-container').height());

                    // load results
                    var results = $('#results');
                    results.text(''); // clear
                    var first = true;
                    for (var i = 0; i < citations.length; i++) {
                        var n = show_cite(citations[i]);
                        if (n == null) continue;
                        results.append(n);
                        if (!first) n.addClass('not-first');
                        first = false;
                    }

                    // did we have any displayable results?
                    if (first)
                        alert("We don't have any links to that citation.");
                    // if so, scroll to them
                    else
                        smooth_scroll_to($('#results'));

                    // expand height of wrapper container to the new appropriate height
                    $('#results-container').animate({ height: $('#results').height() },
                        function() { $('#results-container').css({ height: 'auto' }) });
                }
            })
        }

        var citation_authority_names = {
            usconst: "United States Constitution",
            usc: "United States Code",
            law: "U.S. Slip Law",
            stat: "U.S. Statutes at Large",
            us_bill: "U.S. Bills and Resolutions",

            fedreg: "Federal Register",
            cfr: "Code of Federal Regulations",

            reporter: "Case Law", // exact authority is very hard to decipher from the abbreviated name of the reporter publication in the citation -- but the Court Listener API will tell us more, and in most cases will mean we don't fall back to using this string

            dc_code: "Code of the District of Columbia",
            va_code: "Code of Virginia"
        };

        var citators_with_icons = [ 'cornell_lii', 'courtlistener', 'govtrack', 'house', 'libraryofcongress', 'usgpo', 'nara' ];

        var link_formats = { "pdf": "PDF", "text": "Text", "landing": "Web Page", "html": "HTML", "mods": "MODS" };

        function show_cite(cite, is_parallel) {
            var node = $("<div class='citation'></div>");

            // Display the canonical citation given to us in the heading, or
            // if none is provided then just the matched string.
            var heading_main = cite.citation || cite.match;
            var heading_subhead = null;
            if (cite.title) {
                // If the citation has a nice document title, use that as
                // the primary heading.
                heading_subhead = heading_main;
                heading_main = cite.title;
            }
            var heading_node = $(!is_parallel ? '<h2/>' : '<h3/>')
                .addClass('cite-font')
                .text(heading_main);
            if (heading_subhead)
                heading_node.append($("<div class='subhead'/>").text(heading_subhead));
            node.append(heading_node);

            // Show the authority (i.e. the type of citation) as a subhead.
            node.append($("<div class='cite-authority'/>").text(
                   cite.authority
                || citation_authority_names[cite.type]
                || cite.type));

            node.append($("<div class='permalinks'/>"))
            node.append($("<div class='parallel-cites hidden'/>"))
            //node.append($("<div/>").text(JSON.stringify(cite)));

            var has_links = false;
            for (var key in cite) {
                // the key might be 'usc' or another citator name, or some other metadata

                if (cite[key] && cite[key].links) {
                    // this is a citator with links

                    for (var source_key in cite[key].links) {
                        has_links = true;

                        var link = $("<div class='row'>"
                            +"<div class='col-sm-1'><img class='img-responsive'></div>"
                            +"<div class='col-sm-11'>"
                            +"<div class='link'><a/> (<span class='link-type'></span>)</div>"
                            +"<div class='note'></div>"
                            +"<div class='other hidden'>also:</div>"
                            +"</div>"
                            +"</div>");

                        if (citators_with_icons.indexOf(source_key) >= 0)
                            link.find("img").attr('src', '/source-icons/' + source_key + '.png');
                        else
                            link.find("img").addClass('empty');

                        var source = cite[key].links[source_key].source;
                        link.find(".note").text(source.note);

                        var first_format = true;
                        for (var f in link_formats) {
                            var url = cite[key].links[source_key][f];
                            if (url) {
                                if (first_format) {
                                    link.find(".link a").text(source.name);
                                    link.find(".link a").attr('href', url);
                                    link.find(".link-type").text(link_formats[f]);
                                    first_format = false;
                                } else {
                                    var ff = $("<a/>")
                                    ff.text(link_formats[f]);
                                    ff.attr('href', url);
                                    link.find('.other').removeClass('hidden');
                                    link.find('.other').append(ff);
                                }
                            }
                        }

                        node.find('.permalinks').append(link);
                    }
                }
            }

            // Recursively show parallel citations.
            var first = true;
            for (var i = 0; i < (cite.parallel_citations || []).length; i++) {
                var n = show_cite(cite.parallel_citations[i], true);
                if (!n) continue;
                node.find('>.parallel-cites').removeClass('hidden');
                node.find('>.parallel-cites').append(n);
                if (!first) n.addClass('not-first');
                first = false;
                has_links = true;
            }

            if (!has_links)
                return null;

            return node;
        }
        </script>

        <script>
        var ga_account_id = 'UA-XXXXX-X';
        if (ga_account_id != 'UA-XXXXX-X') {
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create',ga_account_id);ga('send','pageview');
        }

        var ajax_num_executing_requests = 0;
        function ajax_with_indicator(options) {
          setTimeout("if (ajax_num_executing_requests > 0) $('#ajax_loading_indicator').fadeIn()", 100);
          function hide_loading_indicator() {
            ajax_num_executing_requests--;
            if (ajax_num_executing_requests == 0)
              $('#ajax_loading_indicator').stop(true).hide(); // stop() prevents an ongoing fade from causing the thing to be shown again after this call
          }
          var old_success = options.success;
          var old_error = options.error;
          options.success = function(data) {
            hide_loading_indicator();
            if (data.status == "error")
              alert(data.message);
            else if (old_success)
              old_success(data);
          };
          options.error = function(jqxhr) {
            hide_loading_indicator();
            if (!old_error) 
              alert("Something went wrong, sorry.")
            else
              old_error(jqxhr.responseText, jqxhr);
          };
          ajax_num_executing_requests++;
          $.ajax(options);
          return false; // handy when called from onclick
        }

        function smooth_scroll_to(elem) {
          $('html, body').animate({
              scrollTop: Math.max(elem.offset().top-100, 0)
          });
        }
        </script>
    </body>
</html>
